---
title: "元器件生存时间模拟分析-代码"
author: "Miao Cai"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document:
    number_sections: yes
header-includes:
- \usepackage{soulutf8}
- \usepackage{color}
- \usepackage{float}
- \usepackage[UTF8]{ctex}
link-citations: yes
linkcolor: blue
csl: chinese.csl
bibliography: ref.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE)
```

# 数据模拟生成

```{r eval=FALSE}
set.seed(123)

alpha = matrix(c(0.001, 0.05, 0.0001, 0.08), ncol = 2, byrow = TRUE)
w = c(45, 55)
t = matrix(seq(10, 40, 10), ncol = 2, byrow = TRUE)
K = c(10, 50, 100)


lambda = function(r = 1:2, j = 1:2) {
  alpha_r0 = alpha[r, 1]
  alpha_r1 = alpha[r, 2]
  return(alpha_r0*exp(alpha_r1*w[j]))
}

p = function(i = 1:2, j = 1:2){
  lam1j = lambda(1, j) # failure due to factor 1
  lam2j = lambda(2, j) # failure due to factor 2
  
  p0 = exp(-(lam1j + lam2j)*t[i, j])
  p1 = (lam1j/(lam1j + lam2j))*(1 - p0)
  p2 = (lam2j/(lam1j + lam2j))*(1 - p0)
  
  return(c(p0, p1, p2))
}

Tmatrxi = t(rmultinom(100, K[3], prob = p(1, 1)))
```

# Stan代码

```{r eval=FALSE}
reliab = "
data {
  int<lower=0> n;
  int DAT[n, 3];
  vector[2] W;
  vector[4] Tim;
}
parameters{
  real<lower=0, upper=0.5> a10; 
  real<lower=0, upper=0.5> a11;
  real<lower=0, upper=0.5> a20; 
  real<lower=0, upper=0.5> a21;
}
transformed parameters{
  real<lower=0, upper=1> p0; 
  real<lower=0, upper=1> p1; 
  real<lower=0, upper=1> p2;
  vector<lower=0, upper=1>[3] p;
  
  p0 = exp(-(a10*exp(a11*W[1]) + a20*exp(a21*W[2]))*Tim[1]);
  p1 = (a10*exp(a11*W[1]))/(a10*exp(a11*W[1]) + a20*exp(a21*W[2]))*(1 - p0);
  p2 = 1-p0-p1;
  p = [p0, p1, p2]';
}
model{
  for (i in 1:n){
    //target += multinomial_lpmf(DAT[i,] | p);
    DAT[i,] ~ multinomial(p);
    //DAT[i,] ~ multi_log(p0, p1, p2);
  }
  a10 ~ gamma(1, 1);
  a11 ~ gamma(1, 1);
  a20 ~ gamma(1, 1);
  a21 ~ gamma(1, 1);
}
"
```

# Stan抽样

```{r}
library(rstan)
rstan_options(auto_write = TRUE)

stan_dat = list(
  n = nrow(Tmatrxi),
  DAT = Tmatrxi,
  W = w,
  Tim = seq(10, 40, 10)
)

fit <- stan(
  model_code = reliab, data = stan_dat, #init_r = 0.1, init = 0.001, 
  warmup = 1000, iter = 2000, chains = 1, cores = 1, seed = 3)

summary(fit)
```

